<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  <title>Document</title>
  <link rel="stylesheet" href="style.css">
</head>

<body id="body2">
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Contest-Remainder</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="#">Contact</a>
            </li>
           
          </ul>
          
        </div>
      </div>
    </nav>


  </header>
  <main>
    <div class="contestdetails my-4">
      <div class="contestdetails1">
        <div class="my-3">
          <label>Contest-Name:</label>
          <input class="Contest-Name" type="text" required><br>
        </div>
        <div class="my-3">
          <label for="date">Date:</label>
          <input type="date" class="date" name="date" required>
        </div>
        <div class="my-3>
          <label for=" time">Time:</label>
          <input type="time" class="time" name="time" required>
        </div>
        <div>
          <button class="submit btn btn-warning my-3">submit</button>
        </div>
      </div>
    </div>
    <div class="heading">
      <h2>Contests Details</h2>
    </div>
    <div class="cardscontainer ">

    </div>

  </main>
  <footer>
    <div class="footer-columns">
      <div class="footer-column">
        <h2>Navigation</h2>
        <ul>
          <li><a href="#">Home</a></li>
          <li><a href="#">About Us</a></li>
          <li><a href="#">Services</a></li>
          <li><a href="#">Contact</a></li>
        </ul>
      </div>
      <div class="footer-column">
        <h2>Contact Us</h2>
        <p>Email: info@example.com</p>
        <p>Phone: (123) 456-7890</p>
      </div>
      <div class="footer-column footer-social">
        <h2>Follow Us</h2>
        <a href="#" target="_blank">Facebook</a>
        <a href="#" target="_blank">Twitter</a>
        <a href="#" target="_blank">Instagram</a>
      </div>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
  <script>
    var submitdetails = document.querySelector(".submit");
    var cardscontainer = document.querySelector(".cardscontainer");

    submitdetails.addEventListener('click', (event) => {
      event.preventDefault();
      const contestname = document.querySelector(".Contest-Name").value;
      const dateValue = document.querySelector(".date").value;
      const timeValue = document.querySelector(".time").value;
      const Time = dateValue + "%" + timeValue;
      const formData = new URLSearchParams();
      formData.append('Contestname', contestname);
      formData.append('Contestdate', dateValue);
      formData.append('Contesttime', timeValue);
      fetch(`http://localhost:4123/insertcheck`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData.toString(),
      })
        .then(response => response.text())
        .then(message => {
          if (message === "Record exists. Redirecting...") {
            alert('this entry already exits')
          } else {
            fetch(`http://localhost:4123/insertinfo`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: formData.toString(),
            })
              .then(response => response.text())
              .then(message => {
                alert('succesfully registered')
                renderTable();
              })
              .catch(error => {
                console.error(error);
              });
          }
        })
        .catch(error => {
          console.error(error);
        });

    });
    window.onload = function () {
      const containerWidth = parseInt(window.getComputedStyle(cardscontainer).width);

// Check if the width is less than or equal to 600
if (containerWidth <= 600) {
    // Set the styles directly using the style property
    console.log('1');
    cardscontainer.style.gridTemplateColumns = 'repeat(1, 1fr)';
    cardscontainer.style.maxwidth="100vw";
    cardscontainer.style.gap = '40px';
    cardscontainer.style.paddingLeft='40px';
}

      renderTable();
    }
    function renderTable() {
      fetch('/getArray')
        .then(response => response.json())
        .then(data => {
          let str = "";
          data.forEach((element, index) => {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth() + 1;
            const currentDay = currentDate.getDate();
            var year1 = Number(element.Contestdate.substring(0, 4));
            var month1 = Number(element.Contestdate.substring(5, 7));
            var day1 = Number(element.Contestdate.substring(8, 10));
            var hours1 = Number(element.Contesttime.substring(0, 2));
            var mins1 = Number(element.Contesttime.substring(3, 5));
            const currentTime = new Date();

            const currentHours = currentTime.getHours();
            const currentMinutes = currentTime.getMinutes();
            if (year1 < currentYear || month1 < currentMonth || day1 < currentDay || hours1 < currentHours) {
              str += `
      <div class="card red">
        <div class="img"></div>
        <div class="contestname">
          <label>Contest-Name</label>
          <h5 class="contest1">${element.Contestname}</h5>
        </div>
        <div class="enddate">
          <label for="date">Date</label>
          <h5 class="date1">${element.Contestdate}</h5>
        </div>
        <div class="endtime">
          <label for "time">Time</label>
          <h5 class="time1">${element.Contesttime}</h5>
        </div>
        <div class="button">
          <button class="remove" data-index="${index}" onclick="removeItem(this)">remove</button>
        </div>
      </div>
      `;

            }
            else {
              if (hours1 == currentHours && mins1 <= currentMinutes) {
                str += `
      <div class="card " >
        <div class="img"></div>
        <div class="contestname">
          <label>Contest-Name</label>
          <h5 class="contest1">${element.Contestname}</h5>
        </div>
        <div class="enddate">
          <label for="date">Date</label>
          <h5 class="date1">${element.Contestdate}</h5>
        </div>
        <div class="endtime">
          <label for "time">Time</label>
          <h5 class="time1">${element.Contesttime}</h5>
        </div>
        <div class="button">
          <button class="remove" data-index="${index}" onclick="removeItem(this)">remove</button>
        </div>
      </div>
      `;
              }
              else {
                str += `
      <div class="card " >
        <div class="img"></div>
        <div class="contestname">
          <label>Contest-Name</label>
          <h5 class="contest1">${element.Contestname}</h5>
        </div>
        <div class="enddate">
          <label for="date">Date</label>
          <h5 class="date1">${element.Contestdate}</h5>
        </div>
        <div class="endtime">
          <label for "time">Time</label>
          <h5 class="time1">${element.Contesttime}</h5>
        </div>
        <div class="button">
          <button class="remove" data-index="${index}" onclick="removeItem(this)">remove</button>
        </div>
      </div>
      `;

              }
            }
          });

          cardscontainer.innerHTML = str;
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    function removeItem(button) {


      var cona = button.parentNode.parentNode.children[1].children[1].innerText;
      var coda = button.parentNode.parentNode.children[2].children[1].innerText;
      var coti = button.parentNode.parentNode.children[3].children[1].innerText;
      const formData = new URLSearchParams();
      formData.append('Contestname', cona);
      formData.append('Contestdate', coda);
      formData.append('Contesttime', coti);
      fetch(`http://localhost:4123/removedata`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData.toString(),
      })
        .then(response => response.text())
        .then(message => {
          alert('succesfully removed');
          renderTable();
        })
        .catch(error => {
          console.error(error);
        });
    }

    setInterval(checkData, 60000);
    function checkData() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const currentDate = `${year}-${month}-${day}`;
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const currentTime = `${hours}:${minutes}`;


      const formData = new URLSearchParams();
      formData.append('currentdate', currentDate);
      formData.append('currenttime', currentTime);

      fetch(`http://localhost:4123/checkData`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData.toString(),
      })
        .then(response => response.json())
        .then(data => {
          changecolor(data);
          data = [];
        })
        .catch(error => {
          console.error(error);

        });
    }
    function changecolor(data) {
      var cards = document.getElementsByClassName("card ");
      data.forEach((element, index) => {
        for (var i = 0; i < cards.length; i++) {
          var conna = cards[i].querySelector(".contestname .contest1").innerText;
          var conda = cards[i].querySelector(".enddate .date1").innerText;
          var canti = cards[i].querySelector(".endtime .time1").innerText;
          if (element.Contestname === conna && element.Contestdate === conda && element.Contesttime === canti) {
            console.log(cards[i]);
            cards[i].style.backgroundColor = "rgb(109, 59, 48)";
            const formData = new URLSearchParams();
            var recipent = "thumatipavanchowdary@gmail.com";
            var sub = 'FROM CONTEST REMAINDER';
            var msg = `You have contest ${conna} at date-> ${conda} and time->${canti} `;
            formData.append('recipent', recipent);
            formData.append('sub', sub);
            formData.append('msg', msg);
            fetch(`http://localhost:4123/send-email`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
              },
              body: formData.toString(),
            })
              .then(response => response.text())
              .then(message => {
                alert("mailsend");
              })
              .catch(error => {
                console.error(error);
              });
          }
        }
      });
    }




  </script>
</body>

</html>