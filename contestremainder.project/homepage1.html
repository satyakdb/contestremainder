<!DOCTYPE html>
<html>

<head>
  <title>ContestRemainder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
</head>

<body>

  <header>

  </header>
  <main>
    <div class="contestdetails">
      <label>Contest-Name:</label>
      <input class="Contest-Name" type="text" required><br>
      <label for="date">Date:</label>
      <input type="date" class="date" name="date" required>
      <label for="time">Time:</label>
      <input type="time" class="time" name="time" required>
      <button class="submit">submit</button>
    </div>

    <table class="table">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Contest-Name</th>
          <th scope="col">Contest-Held</th>
          <th scope="col">$</th>
        </tr>
      </thead>
      <tbody class="tablebody">
      </tbody>
    </table>

  </main>
  <footer>

  </footer>
  <script>
   
    var buttonclicked = document.getElementById("button");
    const array = [];

    buttonclicked.addEventListener('click', (event) => {
      event.preventDefault();
      const personemail = document.getElementById("recipent").value;
      const subj = document.getElementById("sub").value;
      const masg = document.getElementById("msg").value;
      const subarray = {
        personemail,
        subj,
        masg,
      };
      array.push(subarray);

    });

    function sendmail(contestname) {

      const recipent = array[0].personemail;
      const sub = `Mail from contestRemainder`;
      const msg = `Time for ${contestname} has arrived!`;
      const formData = new URLSearchParams();
      formData.append('recipent', recipent);
      formData.append('sub', sub);
      formData.append('msg', msg);
      fetch(`http://localhost:4123/send-email`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData.toString(),
      })
        .then(response => response.text())
        .then(message => {
          alert(message);
        })
        .catch(error => {
          alert(error);
        });
    }
    var table = document.getElementsByClassName("table")[0];
    var tablebody = document.getElementsByClassName("tablebody")[0];
    var submitdetails = document.getElementsByClassName("submit")[0];
    const entries = []; // To store contest entries and associated interval IDs

    submitdetails.addEventListener('click', (event) => {
      event.preventDefault();
      const contestname = document.getElementsByClassName("Contest-Name")[0].value;
      const dateValue = document.getElementsByClassName("date")[0].value;
      const timeValue = document.getElementsByClassName("time")[0].value;
      const Time = dateValue + "%" + timeValue;

      const entry = {
        contestname,
        Time,
        intervalId: null, // Initialize the interval ID to null
        removed: false, // Initially, the entry is not removed
      };

      entries.push(entry);
      renderTable();

      const interval = 60 * 1000;
      checkEntries();

      // Set an interval to periodically check all entries
      setInterval(() => checkEntries(), interval);
    });

    function renderTable() {
      var str = "";
      entries.forEach((entry, index) => {
        if (!entry.removed) {
          str += `<tr id="${entry.contestname}">
                <th scope="row">${index + 1}</th>
                <td>${entry.contestname}</td>
                <td>${entry.Time}</td>
                <td><button class="remove" data-index="${index}">remove</button></td>
            </tr>`;
        }
      });

      tablebody.innerHTML = str;

      var clickedremoved = document.getElementsByClassName("remove");
      for (var i = 0; i < clickedremoved.length; i++) {
        clickedremoved[i].addEventListener('click', (event) => {
          const indexToRemove = event.target.getAttribute("data-index");
          entries[indexToRemove].removed = true; // Mark the entry as removed
          renderTable();
        });
      }
    }

    function checkEntries() {
      const currentTime = new Date();
      entries.forEach(entry => {
        if (!entry.removed && entry.intervalId === null) {
          const { Time, contestname } = entry;
          const targetTime = new Date(Time);
          targetTime.setSeconds(0); // Set seconds to zero

          const currentDate = new Date(
            currentTime.getFullYear(),
            currentTime.getMonth(),
            currentTime.getDate(),
            currentTime.getHours(),
            currentTime.getMinutes(),
            0 // Set seconds to zero
          );

          if (currentDate >= targetTime) {
            sendmail(contestname);
            entry.intervalId = undefined;
            alert(`Time for ${contestname} has arrived!`);
          }
        }
      });
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>
</body>

</html>